# PyCore Services 开发规范

## Service 使用场景

- 需要多步骤编排
- 需要维护状态/上下文
- 复杂业务流程
- 例如：用户注册流程、订单处理流程

## 架构选择

| 应用类型 | 架构选择 | 说明 |
|---------|---------|------|
| 普通业务系统（无 AI 功能）| Router → Service → Repository | 不需要 Plugin 层 |
| AI Agent 应用（有对话/智能功能）| Router → Plugin → Service | Plugin 作为 LLM 可调用的工具 |

## Repository 基类

```python
# src/repositories/base.py
from typing import TypeVar, Generic, Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

T = TypeVar("T")

class BaseRepository(Generic[T]):
    def __init__(self, db: AsyncSession, model: type[T]):
        self.db = db
        self.model = model

    async def get_by_id(self, id: int) -> Optional[T]:
        result = await self.db.execute(select(self.model).where(self.model.id == id))
        return result.scalar_one_or_none()

    async def create(self, obj: T) -> T:
        self.db.add(obj)
        await self.db.flush()
        return obj
```

## 数据库会话管理

```python
# src/db/session.py
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker

engine = create_async_engine(DATABASE_URL, echo=DEBUG)
async_session = async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)

async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with async_session() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise
```
