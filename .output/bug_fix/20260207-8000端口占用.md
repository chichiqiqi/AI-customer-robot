# BUG 修复报告

> 修复时间：2026-02-07 14:42

---

## 一、用户原话

> INFO:     Application startup complete.
> ERROR:    [Errno 48] error while attempting to bind on address ('0.0.0.0', 8000): address already in use
> INFO:     Waiting for application shutdown.
> 2026-02-07 14:41:49.326 | INFO     | pycore.api.server:lifespan:138 | Shutting down API server...
> 2026-02-07 14:41:49.326 | INFO     | backend.src.main:close_db:71 | 数据库连接已关闭
> 2026-02-07 14:41:49.326 | INFO     | pycore.api.server:lifespan:144 | API server stopped
> INFO:     Application shutdown complete.

---

## 二、问题分析

### 现象
再次在终端执行 `uvicorn backend.src.main:app --host 0.0.0.0 --port 8000` 时，报错 **address already in use**，应用无法绑定 8000 端口并随即退出。

### 触发条件
- 在 8000 端口已被占用的前提下，再次启动后端服务。

### 错误信息
```
[Errno 48] error while attempting to bind on address ('0.0.0.0', 8000): address already in use
```

### 影响范围
- 无法在当前终端启动新的后端实例；若未发现旧进程，会误以为“启动失败”。

---

## 三、可能原因

1. **[最可能]** 之前已启动过后端（如后台运行的 uvicorn），该进程仍占用 8000 端口。
   - 依据：错误为“地址已被使用”，且 `lsof -i :8000` 可见 Python 进程。
   - 检查：终端/后台是否已有 uvicorn 在跑。

2. **[较可能]** 本机其他应用（如其它项目、其他服务）占用了 8000。
   - 依据：同一台机多项目或多服务时常见。
   - 检查：`lsof -i :8000` 看 COMMAND 和 PID。

3. **[可能]** 上次异常退出导致进程未正常结束，端口未释放。
   - 依据：Ctrl+C 未生效或终端被关掉时可能出现。
   - 检查：用 `lsof -i :8000` 确认占用进程后结束该进程。

---

## 四、根本原因

**类型**：环境/运维问题（非业务代码 BUG）

**原因**：8000 端口已被占用。本次排查时，占用进程为之前启动的 uvicorn（Python，PID 14558）。在同一端口上再次启动 uvicorn 会导致 bind 失败，报 `Errno 48`。

---

## 五、解决方案

**修复方式**：先释放 8000 端口，再启动后端。

### 步骤 1：查看占用 8000 端口的进程
```bash
lsof -i :8000
```
示例输出：
```
COMMAND   PID   USER   FD   TYPE  ...
Python  14558 chichi  ...  TCP *:irdmi (LISTEN)
```

### 步骤 2：结束该进程（将 14558 换成你看到的 PID）
```bash
kill 14558
```
若普通 `kill` 无效，可强制结束：
```bash
kill -9 14558
```

### 步骤 3：再次启动后端
```bash
cd "/Users/chichi/.../第一期终极版开发包"
python3 -m uvicorn backend.src.main:app --host 0.0.0.0 --port 8000
```

**可选**：若希望保留 8000 给其他程序，可改用其他端口启动后端，例如：
```bash
python3 -m uvicorn backend.src.main:app --host 0.0.0.0 --port 8001
```
此时前端需能访问 8001（如修改前端 API baseURL 或代理配置）。

**修改文件列表**：无（仅操作终端命令，未改代码）。

---

## 六、验证结果

- [x] 确认 8000 被占用的原因（旧 uvicorn 进程）
- [x] 提供释放端口并重新启动的步骤
- [x] 未修改项目代码

---

## 七、经验总结

**教训**：同一端口只能被一个进程监听；重复启动服务前应先确认端口是否已被占用。

**预防**：
- 启动前用 `lsof -i :8000` 检查是否已有进程。
- 若不需要旧进程，先 `kill <PID>` 再启动。
- 使用 `--reload` 开发时，尽量只在一个终端运行 uvicorn，避免多次启动导致端口冲突。
